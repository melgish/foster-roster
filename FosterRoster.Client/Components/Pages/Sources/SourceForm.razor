@inject DialogService DialogService

@if (_model is null)
{
    <Loading/>
}
else
{
    <EditForm FormName="editSource" Model="_model" OnValidSubmit="SaveAsync">
        <FluentValidationValidator/>
        <RadzenStack Gap="0.5rem">
            <RadzenRow Gap="1rem" RowGap="0.5rem">
                <RadzenColumn Size="12">
                    <RadzenText Text="@_name" TextStyle="TextStyle.DisplayH4"/>
                </RadzenColumn>
            </RadzenRow>
            <RadzenRow Gap="1rem" RowGap="0.5rem">
                <RadzenColumn SizeSm="6" SizeXS="12">
                    <RadzenStack Gap="0rem">
                        <RadzenFormField AllowFloatingLabel="false" Text="Name" Variant="Variant.Text">
                            <RadzenTextBox @bind-Value="_model.Name"/>
                        </RadzenFormField>
                        <ValidationMessage For="@(() => _model.Name)"/>
                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>
            <RadzenRow Gap="1rem" RowGap="0.5rem">
                <RadzenColumn Size="12">
                    <AppFormButtons
                        Busy="_isSaving"
                        IsNew="IsNew"
                        OnDelete="OnDelete"
                        OnReset="ResetAsync">
                    </AppFormButtons>
                </RadzenColumn>
            </RadzenRow>
        </RadzenStack>

    </EditForm>
}

@code {
    private bool _isSaving;
    private string _name = string.Empty;
    private SourceEditModel? _model;

    [Parameter] public bool IsNew { get; set; }
    [Parameter] public Source Source { get; set; } = null!;

    /// <summary>
    ///     Event fired when delete button is clicked.
    /// </summary>
    [Parameter]
    public EventCallback OnDelete { get; set; }

    /// <summary>
    ///     Event fired when save button is clicked.
    /// </summary>
    [Parameter]
    public EventCallback<SourceEditModel> OnSave { get; set; }

    /// <summary>
    ///     Resets form any time the parent Source is updated.
    /// </summary>
    protected override Task OnParametersSetAsync() => ResetAsync();

    /// <summary>
    ///     Resets the form back to it's initial state.
    /// </summary>
    private Task ResetAsync()
    {
        _model = new(Source);
        _name = IsNew ? "Create Source" : Source.Name;
        return Task.CompletedTask;
    }


    private async Task SaveAsync()
    {
        _isSaving = true;
        await OnSave.InvokeAsync(_model);
        _isSaving = false;
    }

}