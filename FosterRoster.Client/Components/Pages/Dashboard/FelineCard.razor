@inject TimeProvider TimeProvider
@inject IFelineRepository FelineRepository
@inject ILogger<FelineCard> Logger

@if (Feline is null)
{
    <RadzenCard>
        <RadzenText Text="Loading..."/>
    </RadzenCard>
}
else
{
    <RadzenCard Variant="Variant.Filled">
        <RadzenStack Gap="1rem">
            <RadzenStack AlignItems="AlignItems.Center"
                         JustifyContent="JustifyContent.SpaceBetween"
                         Orientation="Orientation.Horizontal">
                <RadzenText Text="@Feline.Name" TextStyle="TextStyle.DisplayH6" TagName="TagName.Div"
                            Style="margin-bottom: 0"/>
                <AppFileInput OnChange="@OnFilesChangedAsync" Size="ButtonSize.Small" Rounded="true"/>
            </RadzenStack>
            <RadzenLink Path=@($"/details/{Feline!.Id}")>
                <RadzenImage AlternateText="@Feline.Name"
                             Path="@Feline.Thumbnail.GetUrl()"
                             Style="width:180px;height:180px;background-color:var(--rz-primary-lighter);border-radius: 1rem;"/>
            </RadzenLink>
            <RadzenStack Gap="0rem">
                <RadzenText Text="@GenderCategory" TextStyle="TextStyle.Body1"/>
                <RadzenText Text="@Feline.FormatAge(TimeProvider.GetUtcNow())"/>
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>
}

@code {

    /// <summary>
    /// Feline to display.
    /// </summary>
    [Parameter]
    public Feline? Feline { get; set; }

    /// <summary>
    /// Gender and category of the feline.
    /// </summary>
    private string GenderCategory => $"{Feline?.Gender} {Feline?.Category}";

    /// <summary>
    /// Fired if Feline is updated.
    /// </summary>
    [Parameter]
    public EventCallback<Feline> FelineChanged { get; set; }

    /// <summary>
    /// Handles quick change of the thumbnail from the dashboard.
    /// </summary>
    /// <param name="args"></param>
    private async Task OnFilesChangedAsync(InputFileChangeEventArgs args)
    {
        var thumbnail = await args.File.ToThumbnailAsync(Feline!.Id);
        if (thumbnail is not null)
        {
            var rs = await FelineRepository.SetThumbnailAsync(Feline.Id, thumbnail);
            if (rs.IsSuccess)
            {
                Feline = rs.Value;
                await FelineChanged.InvokeAsync(Feline);
            }
        }
    }

}