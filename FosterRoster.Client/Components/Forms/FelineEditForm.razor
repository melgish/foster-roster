@inject IDialogService DialogService

@if (model is null)
{
    <p>Loading...</p>
}
else
{
    <EditForm Model="@model"
              OnValidSubmit="@SaveAsync"
              FormName="editFeline">
        <FluentValidationValidator />
        <MudGrid Spacing="3">
            <MudItem xs="12">
                <h1>@name</h1>
            </MudItem>
            <MudItem xs="4">
                <MudFileUpload Accept="image/png"
                               Disabled="@model.IsInactive"
                               FilesChanged="@OnFilesChangedAsync"
                               T="IBrowserFile">
                    <ActivatorContent>
                        <MudImage Alt="Thumbnail"
                                  Src="@model.Thumbnail.GetUrl()"
                                  Height="256"
                                  Width="256" />
                        <MudIconButton Color="Color.Default"
                                       Disabled="@model.IsInactive"
                                       Icon="@Icons.Material.Rounded.CameraAlt" />
                    </ActivatorContent>
                </MudFileUpload>
            </MudItem>
            <MudItem xs="8">
                <MudStack>
                    <MudDatePicker @bind-Date="model.IntakeDate"
                                   Disabled="@model.IsInactive"
                                   Editable="true"
                                   Label="Intake Date"
                                   Required
                                   RequiredError="" />
                    <ValidationMessage For="@(() => model.IntakeDate)" />
                    <MudTextField @bind-Value="model.Name"
                                  Disabled="@model.IsInactive"
                                  Label="Name" />
                    <ValidationMessage For="@(() => model.Name)" />
                    <MudField Label="Gender">
                        <MudRadioGroup T="Gender"
                                       @bind-Value="model.Gender"
                                       Class="ps-2"
                                       Disabled="@model.IsInactive"
                                       Style="margin-top:-0.5rem">
                            <MudRadio Dense
                                      Size="Size.Small"
                                      Value="@Gender.Female">Female</MudRadio>
                            <MudRadio Dense
                                      Size="Size.Small"
                                      Value="@Gender.Male">Male</MudRadio>
                        </MudRadioGroup>
                        <ValidationMessage For="@(() => model.Gender)" />
                    </MudField>
                    <MudNumericField @bind-Value="model.IntakeAgeInWeeks"
                                     Disabled="@model.IsInactive"
                                     HideSpinButtons
                                     Label="Age at Intake (weeks)"
                                     Min="0" />
                    <ValidationMessage For="@(() => model.IntakeAgeInWeeks)" />
                </MudStack>
            </MudItem>
            <MudItem xs="6">
                <MudTextField @bind-Value="model.Breed"
                              Disabled="@model.IsInactive"
                              Label="Breed" />
                <ValidationMessage For="@(() => model.Breed)" />
            </MudItem>
            <MudItem xs="6">
                <MudTextField @bind-Value="model.Color"
                              Disabled="@model.IsInactive"
                              Label="Color" />
                <ValidationMessage For="@(() => model.Color)" />
            </MudItem>
            <MudItem xs="6">
                <SourceSelect @bind-Value="model.SourceId"
                              Disabled="@model.IsInactive" />
                <ValidationMessage For="@(() => model.SourceId)" />
            </MudItem>
            <MudItem xs="6">
                <MudSelect @bind-Value="model.Category"
                           Disabled="@model.IsInactive"
                           Label="Category"
                           Required>
                    <MudSelectItem Value="@Category.Kitten">Kitten</MudSelectItem>
                    <MudSelectItem Value="@Category.NursingKitten">Nursing Kitten
                    </MudSelectItem>
                    <MudSelectItem Value="@Category.Cat">Cat</MudSelectItem>
                    <MudSelectItem Value="@Category.NursingCat">Nursing Cat</MudSelectItem>
                </MudSelect>
                <ValidationMessage For="@(() => model.Category)" />
            </MudItem>
            <MudItem xs="6">
                <MudDatePicker @bind-Date="model.RegistrationDate"
                               Clearable="true"
                               Disabled="@model.IsInactive"
                               Editable="true"
                               Label="Registration Date" />
                <ValidationMessage For="@(() => model.RegistrationDate)" />
            </MudItem>
            <MudItem xs="6">
                <MudField Label="Weaned">
                    <MudRadioGroup @bind-Value="model.Weaned"
                                   Class="ps-2"
                                   Style="margin-top:-0.5rem"
                                   Disabled="@model.IsInactive">
                        <MudRadio Dense
                                  Size="Size.Small"
                                  Value="@Weaned.No">No</MudRadio>
                        <MudRadio Dense
                                  Size="Size.Small"
                                  Value="@Weaned.InProgress">In Progress</MudRadio>
                        <MudRadio Dense
                                  Size="Size.Small"
                                  Value="@Weaned.Yes">Yes</MudRadio>
                    </MudRadioGroup>
                </MudField>
                <ValidationMessage For="@(() => model.Weaned)" />
            </MudItem>
            <MudItem xs="12">
                <MudStack Row="true"
                          AlignItems="AlignItems.Center">
                    @if (model.IsInactive)
                    {
                        <MudText>
                            Inactive as of @model.InactivatedAtUtc
                        </MudText>
                    }
                    <MudSpacer />
                    @if (isSaving)
                    {
                        <MudProgressCircular Color="Color.Primary"
                                             Indeterminate="true"
                                             StrokeWidth="4" />
                    }
                    @if (!IsNew)
                    {
                        @if (model.IsInactive)
                        {
                            <MudButton ButtonType="ButtonType.Button"
                                       Color="Color.Info"
                                       Disabled="@(isSaving || !model.IsInactive)"
                                       OnClick="@ActivateAsync"
                                       Variant="Variant.Outlined">Activate</MudButton>
                        }
                        else
                        {
                            <MudButton ButtonType="ButtonType.Button"
                                       Color="Color.Info"
                                       Disabled="@(isSaving || model.IsInactive)"
                                       OnClick="@InactivateAsync"
                                       Variant="Variant.Outlined">Inactivate</MudButton>
                        }
                        <MudButton ButtonType="ButtonType.Button"
                                   Color="Color.Error"
                                   Disabled="@(isSaving || model.IsInactive)"
                                   OnClick="@DeleteAsync"
                                   Variant="Variant.Outlined">Delete</MudButton>
                    }
                    <MudButton ButtonType="ButtonType.Submit"
                               Color="Color.Primary"
                               Disabled="@(isSaving || model.IsInactive)"
                               Variant="Variant.Outlined">Save</MudButton>

                    <MudButton Color="Color.Secondary"
                               Disabled="@(isSaving || model.IsInactive)"
                               OnClick="@ResetAsync"
                               Variant="Variant.Outlined">Reset</MudButton>
                </MudStack>
            </MudItem>
        </MudGrid>
    </EditForm>
}

@code {
    private bool isSaving = false;
    private string name = string.Empty;
    private FelineEditModel? model = null;

    [Parameter]
    public Feline Feline { get; set; } = null!;

    [Parameter]
    public bool IsNew { get; set; } = false;

    [Parameter]
    public EventCallback OnActivate { get; set; } = EventCallback.Empty;

    [Parameter]
    public EventCallback OnDelete { get; set; } = EventCallback.Empty;

    [Parameter]
    public EventCallback<DateTimeOffset> OnInactivate { get; set; } =
    EventCallback<DateTimeOffset>.Empty;

    [Parameter]
    public EventCallback<FelineEditModel> OnSave { get; set; } =
    EventCallback<FelineEditModel>.Empty;

    /// <summary>
    /// Re-activates an inactive cat.
    /// </summary>
    private async Task ActivateAsync()
    {
        isSaving = true;
        await OnActivate.InvokeAsync();
        isSaving = false;
    }

    /// <summary>
    /// Reset any time the parent Feline is updated.
    /// </summary>
    protected override async Task OnParametersSetAsync() => await ResetAsync();

    /// <summary>
    /// Deletes the current cat.
    /// </summary>
    private async Task DeleteAsync()
    {
        var parameters = new DialogParameters();
        parameters.Add(nameof(ConfirmDeleteFelineDialog.Model), model);

        var dialog = await DialogService
        .ShowAsync<ConfirmDeleteFelineDialog>("Confirm Delete", parameters);

        var result = await dialog.Result;
        if (result is null || result.Canceled)
        {
            return;
        }

        isSaving = true;
        await OnDelete.InvokeAsync(Feline.Id);
        isSaving = false;
    }

    /// <summary>
    /// Inactivates the current cat.
    /// </summary>
    private async Task InactivateAsync()
    {
        var parameters = new DialogParameters();
        parameters.Add(nameof(ConfirmInactivateFelineDialog.Feline), model);

        var dialog = await DialogService
        .ShowAsync<ConfirmInactivateFelineDialog>("Confirm Inactivate", parameters);
        var result = await dialog.Result;
        if (result is null || result.Canceled)
        {
            return;
        }

        isSaving = true;
        await OnInactivate.InvokeAsync((DateTimeOffset)result.Data!);
        isSaving = false;
    }

    private async Task OnFilesChangedAsync(IBrowserFile file)
    {
        if (model is not null)
        {
            model.Thumbnail = await file.ToThumbnailAsync(model.Id);
        }
    }

    private Task ResetAsync()
    {
        model = new FelineEditModel(Feline);
        name = IsNew ? "Intake" : model.Name;
        return Task.CompletedTask;
    }

    private async Task SaveAsync()
    {
        isSaving = true;
        await OnSave.InvokeAsync(model);
        isSaving = false;
    }
}